<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Madhabam Tide Widget</title>

<style>
    /* ১. বডি/ব্যাকগ্রাউন্ডের জন্য বেস স্টাইল */
    body {
        margin: 0;
        padding: 0;
        /* শুধুমাত্র উইজেটটিকে তার ব্যাকগ্রাউন্ড কালার দেবে, বাইরের স্ক্রিন নয় */
        font-family: sans-serif;
        color: white;
        background-color: transparent; /* এটি পরিবর্তন করা হলো: পেছনের স্ক্রিনের রঙ নেবে */
    }
    #madhabam-tide-widget {
        max-width: 360px;
        margin: 0 auto;
        padding: 0; /* padding 10px সরিয়ে 0 করা হলো যাতে রঙ না ছড়ায় */
        /* ব্যাকগ্রাউন্ড #00575e এখানে না দিয়ে tide-panel-এ দেওয়া হবে */
    }

    /* ২. উইজেটের প্রধান প্যানেল স্টাইল (ব্যাকগ্রাউন্ড এবং আকার) */
    .tide-panel {
        display: flex;
        background-color: #00575e; /* উইজেটের ব্যাকগ্রাউন্ড (গাড় সবুজ) */
        border-radius: 15px;
        padding: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        color: #fff;
        height: 300px; /* একটি নির্দিষ্ট উচ্চতা সেট করা হলো যাতে জলস্তর বারটি পুরোটা দেখা যায় */
        box-sizing: border-box; /* padding উচ্চতাতে যুক্ত হবে না */
    }

    /* ৩. উইজেটের বাম দিকের অংশ */
    .tide-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding-right: 15px;
        position: relative; /* জলস্তর বারের পাশে অন্যান্য উপাদানগুলির জন্য */
    }

    .tide-header-section {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 10px;
        font-weight: bold;
    }

    .tide-header-title {
        font-size: 1.5em; 
        color: #f7d730; 
    }
    /* "বর্তমান জলস্তর" লেখাটিকে সামান্য উপরে তোলার জন্য */
    .tide-header-section > div:last-child {
        text-align:right;
        font-size:0.7em;
        line-height: 1.2;
    }

    .tide-events-list {
        flex-grow: 1;
        margin-bottom: 10px; /* ফুটার থেকে দূরত্ব */
    }

    .tide-item-compact {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0; /* প্যাডিং কমানো হলো */
        border-bottom: 1px dotted rgba(255, 255, 255, 0.2);
    }
    .tide-item-compact:last-child {
        border-bottom: none;
    }

    .tide-label-group {
        display: flex;
        align-items: center;
    }

    .tide-text-stack {
        display: flex;
        flex-direction: column;
        margin-left: 10px;
    }

    .tide-type-value {
        font-size: 1em;
        font-weight: bold;
        color: #ffffff;
    }

    .tide-time-value {
        font-size: 1.1em;
        font-weight: bold;
        color: #f7d730;
    }
    
    .highlight {
        background-color: rgba(255, 255, 255, 0.2); 
        margin: 0 -15px; /* highlight কে প্যানেলের প্রস্থ অনুযায়ী পুরোটা করার জন্য */
        padding: 6px 15px; /* প্যাডিং যোগ করা */
        border-radius: 4px;
    }
    .highlight .tide-item-compact {
        border-bottom: none;
        padding: 0;
    }
    .highlight:last-child {
        border-bottom: none;
    }

    /* ফুটার স্টাইল */
    .footer-tags-section {
        margin-top: 10px;
        font-size: 0.85em;
        line-height: 1.4;
    }
    .tide-date-footer {
        margin-bottom: 3px;
    }
    .location-time-tag span {
        color: #f7d730;
    }
    
    /* ৪. জলস্তর বার স্টাইল (গুরুত্বপূর্ণ পরিবর্তন) */
    .level-indicator-container {
        width: 40px;
        display: flex;
        align-items: flex-end;
        position: relative;
    }

    .level-indicator-bar {
        width: 25px;
        height: 100%; /* কন্টেইনারের উচ্চতা অনুযায়ী পুরোটা নেবে */
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        position: absolute; /* কন্টেইনারের ভিতরে ফ্লোটিং */
        right: 0;
        top: 0;
        overflow: hidden;
    }

    .water-fill {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background: linear-gradient(to top, #36aee0, #7ec0ee); 
        transition: height 0.5s ease-out; 
    }

    /* ৫. জলস্তর টেক্সট (50%) কে গতিশীল করা */
    .water-level-text {
        position: absolute;
        right: 30px; /* বারের ডান দিকে রাখার জন্য */
        transform: translateY(50%); /* জলস্তরের শতাংশ অনুযায়ী মুভ করার জন্য transform: translate(-50%, 50%) পরিবর্তন করা হলো */
        color: #000;
        font-size: 0.7em;
        font-weight: bold;
        z-index: 10;
        text-shadow: 0 0 2px #fff;
        /* এই টেক্সটটির vertical position JS থেকে control করা হবে */
    }
    
    /* ৬. জোয়ার-ভাটার আইকন (ওয়েভ SVG) */
    .tide-icon-svg {
        display: inline-block;
        width: 24px;
        height: 24px;
        margin-right: 5px;
    }
</style>
</head>

<body>

<div id="madhabam-tide-widget" style="max-width:300px;"></div>

<script>
/* আপনার জাভাস্ক্রিপ্ট কোড — কোনো পরিবর্তন নেই */
(function(){
    const API_OM = 'https://api.open-meteo.com/v1/forecast';
    const API_IP = 'https://ipapi.co/json/';
    const DEFAULT = { lat:22.57, lng:88.36, source:'স্থির স্থানাঙ্ক', city:'কলকাতা' };
    const $ = id => document.getElementById(id);

    const FALLBACK_DATA = { tide_anchor_fallback:'20:30' };

    let STATE = { lat:DEFAULT.lat, lng:DEFAULT.lng, source:DEFAULT.source, city:DEFAULT.city, tides:[] };
    let updateUIInterval = null;
    let updateDataInterval = null;

    function formatToBengali(dateInput, isTime=false, showSeconds=false){
        if(!dateInput) return '—';
        try{
            const date = (dateInput instanceof Date)?dateInput:new Date(dateInput);
            if(isNaN(date)) return '—';
            const opt={ timeZone:'Asia/Kolkata' };
            if(isTime){
                opt.hour='2-digit'; opt.minute='2-digit';
                if(showSeconds) opt.second='2-digit';
                opt.hour12=true;
                return date.toLocaleTimeString('bn-BD',opt);
            }
            opt.day='2-digit'; opt.month='2-digit'; opt.year='numeric';
            return date.toLocaleDateString('bn-BD',opt).replace(/\//g,'-');
        }catch(e){ return '—'; }
    }

    function parseBengaliTime(timeStr,dateContext){
        try{
            const parts=timeStr.split(' ');
            if(parts.length!==2) return null;
            const [timePart,ampm]=parts;
            let [h,m]=timePart.split(':').map(Number);
            if(ampm==='PM'&&h!==12) h+=12;
            if(ampm==='AM'&&h===12) h=0;
            let d=dateContext||new Date();
            d.setHours(h,m,0,0);
            return d;
        }catch(e){ return null; }
    }

    function createWaveSVG(){
        const ns='http://www.w3.org/2000/svg';
        const svg=document.createElementNS(ns,'svg');
        svg.setAttribute('width','24'); svg.setAttribute('height','24'); svg.setAttribute('viewBox','0 0 24 24');
        const style=document.createElementNS(ns,'style');
        style.textContent=`
            .wave{fill:none;stroke:#FFF;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;animation:wave-motion 2s linear infinite alternate;}
            @keyframes wave-motion{0%{transform:translateY(0px);}100%{transform:translateY(-2px);}}
        `;
        svg.appendChild(style);
        const p1=document.createElementNS(ns,'path'); p1.setAttribute('class','wave'); p1.setAttribute('d','M2 12s2-2 4-2 4 2 4 2 2-2 4-2 4 2 4 2'); svg.appendChild(p1);
        const p2=document.createElementNS(ns,'path'); p2.setAttribute('class','wave'); p2.setAttribute('d','M2 16s2-2 4-2 4 2 4 2 2-2 4-2 4 2 4 2'); p2.style.animationDelay='-1s'; svg.appendChild(p2);
        return svg.outerHTML;
    }

    function createGlowArrow(direction,size='1.1em'){
        const arrow=direction==='up'?'▲':'▼';
        const color=direction==='up'?'#32CD32':'#FF4500';
        const shadow=`0 0 5px ${color},0 0 10px ${color}`;
        return `<span style="font-size:${size};color:${color};text-shadow:${shadow};margin-left:5px;position:relative;top:${direction==='up'?'-2px':'2px'};">${arrow}</span>`;
    }

    function approxTides(baseTime){
        let base=new Date();
        if(baseTime && baseTime.includes('T')) base=new Date(baseTime);
        else if(baseTime){
            const d=new Date();
            const [h,m]=baseTime.split(':').map(Number);
            base=new Date(d.getFullYear(),d.getMonth(),d.getDate(),h,m,0);
        }
        const gap=(6*60+12)*60000;
        const out=[];
        const types=['উচ্চ জোয়ার','নিম্ন ভাটা','উচ্চ জোয়ার','নিম্ন ভাটা'];
        for(let i=0;i<4;i++){
            let t=new Date(base.getTime()+i*gap);
            out.push({ type:types[i], time:formatToBengali(t,true), level:(i%2===0)?'high':'low', timestamp:t.getTime() });
        }
        return out.sort((a,b)=>a.timestamp-b.timestamp);
    }

    function getDynamicLevelInfo(tides){
        if(!tides||!tides.length) return {level:50,direction:'static',nextEventIndex:-1};
        const now=Date.now();
        let past=null,next=null,index=-1;

        for(let i=0;i<tides.length;i++){
            if(tides[i].timestamp<=now){ past=tides[i]; next=tides[i+1]; index=i+1; }
            else if(!next){ next=tides[i]; index=i; }
        }

        if(!next){
            next=tides[0];
            past=tides[tides.length-1];
            index=0;
        }

        const start=past&&past.level==='high'?95:5;
        const end=next&&next.level==='high'?95:5;

        let lvl=50;
        let dir='static';

        if(past && next && next.timestamp>past.timestamp){
            const total=next.timestamp-past.timestamp;
            const done=now-past.timestamp;
            lvl=start + ((end-start)*(done/total));
            dir=end>start?'up':'down';
        }

        lvl=Math.max(5,Math.min(95,lvl));
        return { level:Math.round(lvl), direction:dir, nextEventIndex:index };
    }

    function loadCoordinates(){
        return fetch(API_IP).then(r=>r.json()).then(j=>{
            return{
                lat:j.latitude||DEFAULT.lat,
                lng:j.longitude||DEFAULT.lng,
                source:'IP API',
                city:j.city||DEFAULT.city
            };
        }).catch(_=>DEFAULT);
    }

    function buildTideList(tides,info){
        let html='';
        tides.forEach((t,i)=>{
            const hi=i===info.nextEventIndex;
            const ar=hi?createGlowArrow(info.direction,'0.9em'):'';
            html+=`
            <div class="tide-item-compact ${hi?'highlight':''}">
                <span class="tide-label-group">
                    <div class="tide-icon-svg">${createWaveSVG()}</div>
                    <div class="tide-text-stack">
                        <span class="tide-type-value">${t.type}${ar}</span>
                        <span class="tide-time-value">${t.time}</span>
                    </div>
                </span>
            </div>`;
        });
        return html;
    }

    function updateLiveUI(){
        if(!STATE.tides.length) return;
        
        $('local-time-live').textContent=formatToBengali(new Date(),true,true);
        
        const {level,direction}=getDynamicLevelInfo(STATE.tides);
        
        // জলস্তর আপডেট
        $('water-fill').style.height=level+"%";
        
        // জলস্তর টেক্সট আপডেট
        $('water-level-text').textContent=level+"%";
        $('water-level-text').style.bottom=level+"%"; /* CSS পরিবর্তন হওয়ায় এখানে bottom সেট করা হলো */

        // জোয়ার-ভাটা তালিকা আপডেট
        $('tide-events-list').innerHTML=buildTideList(STATE.tides,getDynamicLevelInfo(STATE.tides));
        
        // তীরচিহ্ন আপডেট
        $('panel-arrow-indicator').innerHTML=direction!=='static'?createGlowArrow(direction,'1.4em'):'';
    }

    function buildWidget(data){
        const cur=formatToBengali(new Date(),false);
        const dyn=getDynamicLevelInfo(data.tides);
        const arrow=dyn.direction!=='static'?createGlowArrow(dyn.direction,'1.4em'):'';
        const currentTime=new Date();
        const currentBengaliTime=formatToBengali(currentTime,true,true);
        const currentDate=formatToBengali(currentTime,false);
        
        return `
        <div class="tide-panel">
            <div class="tide-content">
                <div class="tide-header-section">
                    <div class="tide-header-title">জোয়ার-ভাটা</div>
                    <div style="text-align:right;font-size:0.7em;">
                        <span id="panel-arrow-indicator">${arrow}</span><br>বর্তমান জলস্তর
                    </div>
                </div>
                <div class="tide-events-list" id="tide-events-list">${buildTideList(data.tides,dyn)}</div>
                <div class="footer-tags-section">
                    <div class="tide-date-footer">আজ: ${currentDate}</div>
                    <div class="location-time-tag">
                        স্থান: <span>${data.city}</span> | স্থানীয় সময়:
                        <span id="local-time-live">${currentBengaliTime}</span>
                    </div>
                </div>
            </div>
            <div class="level-indicator-container">
                <div id="water-level-text" class="water-level-text" style="bottom:${dyn.level}%;">${dyn.level}%</div>
                <div class="level-indicator-bar">
                    <div id="water-fill" class="water-fill" style="height:${dyn.level}%"></div>
                </div>
            </div>
        </div>`;
    }

    async function loadAllData(){
        const coords=await loadCoordinates();
        STATE.lat=coords.lat; STATE.lng=coords.lng; STATE.city=coords.city;

        let moon=null;
        try{
            const r=await fetch(API_OM+`?latitude=${STATE.lat}&longitude=${STATE.lng}&daily=moonrise&timezone=auto`);
            const j=await r.json();
            moon=(j.daily&&j.daily.moonrise&&j.daily.moonrise[0])?j.daily.moonrise[0]:FALLBACK_DATA.tide_anchor_fallback;
        }catch(e){
            moon=FALLBACK_DATA.tide_anchor_fallback;
        }

        STATE.tides=approxTides(moon);

        $('madhabam-tide-widget').innerHTML=buildWidget(STATE);

        if(updateUIInterval) clearInterval(updateUIInterval);
        updateUIInterval=setInterval(updateLiveUI,100);
        
        if(updateDataInterval) clearInterval(updateDataInterval);
        updateDataInterval=setInterval(loadAllData,1800000);
    }

    loadAllData();
})();
</script>

</body>
</html>
