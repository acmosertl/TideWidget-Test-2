            
            <div class="level-indicator-container">
                <div id="water-level-text" class="water-level-text" 
                     style="bottom:calc(${dyn.level}% - 8px);">${dyn.level}%</div>
                <div class="level-indicator-bar">
                    <div id="water-fill" class="water-fill" style="height:${dyn.level}%"></div>
                </div>
            </div>

            <div class="tide-content">
                <div class="tide-header-section">
                    <div>
                    <div style="text-align:right;font-size:0.7em;">
                        <span id="panel-arrow-indicator">${arrow}</span><br>বর্তমান জলস্তর
                    </div>
                </div>
                <div class="tide-events-list" id="tide-events-list">${buildTideList(data.tides,dyn)}</div>
                
                <div class="footer-tags-section">
                    <div class="tide-date-footer">আজ: ${currentDate}</div>
                    <div class="location-time-tag">
                        স্থান: <span>${data.city}</span> | স্থানীয় সময়:
                        <span id="local-time-live">${currentBengaliTime}</span>
                    </div>
                </div>
            </div>
        </div>`;
    }

    async function loadAllData(){
        const coords=await loadCoordinates();
        STATE.lat=coords.lat; STATE.lng=coords.lng; STATE.city=coords.city;

        let moon=null;
        try{
            // Open-Meteo API call for moonrise time (tide anchor)
            const r=await fetch(API_OM+`?latitude=${STATE.lat}&longitude=${STATE.lng}&daily=moonrise&timezone=auto`);
            if (!r.ok) throw new Error("API not OK");
            const j=await r.json();
            moon=(j.daily&&j.daily.moonrise&&j.daily.moonrise[0])?j.daily.moonrise[0]:FALLBACK_DATA.tide_anchor_fallback;
        }catch(e){
            console.error("Tide data API error, using fallback time.", e);
            moon=FALLBACK_DATA.tide_anchor_fallback;
        }

        STATE.tides=approxTides(moon);
        
        // শহরের নাম আপডেট করা হলো
        document.querySelector('.location-time-tag span').textContent = STATE.city;

        $('madhabam-tide-widget').innerHTML=buildWidget(STATE);

        if(updateUIInterval) clearInterval(updateUIInterval);
        updateUIInterval=setInterval(updateLiveUI,100); 
        
        if(updateDataInterval) clearInterval(updateDataInterval);
        // প্রতি 30 মিনিটে ডেটা পুনরায় লোড করা হবে
        updateDataInterval=setInterval(loadAllData,1800000); 
    }

    loadAllData();
})();
</script>
