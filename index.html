<script>
(function(){
    const API_OM = 'https://api.open-meteo.com/v1/forecast';
    const API_IP = 'https://ipapi.co/json/';
    const DEFAULT = { lat:22.57, lng:88.36, source:'স্থির স্থানাঙ্ক', city:'কলকাতা' };
    const $ = id => document.getElementById(id);

    const FALLBACK_DATA = { tide_anchor_fallback:'20:30' };

    let STATE = { lat:DEFAULT.lat, lng:DEFAULT.lng, source:DEFAULT.source, city:DEFAULT.city, tides:[] };
    let updateUIInterval = null;
    let updateDataInterval = null;

    function formatToBengali(dateInput, isTime=false, showSeconds=false){
        if(!dateInput) return '—';
        try{
            const date = (dateInput instanceof Date)?dateInput:new Date(dateInput);
            if(isNaN(date)) return '—';
            // নিশ্চিত করুন যে সঠিক টাইম জোন ব্যবহার করা হচ্ছে
            const opt={ timeZone:'Asia/Kolkata' }; 
            if(isTime){
                opt.hour='2-digit'; opt.minute='2-digit';
                if(showSeconds) opt.second='2-digit';
                opt.hour12=true;
                return date.toLocaleTimeString('bn-BD',opt);
            }
            opt.day='2-digit'; opt.month='2-digit'; opt.year='numeric';
            return date.toLocaleDateString('bn-BD',opt).replace(/\//g,'-');
        }catch(e){ return '—'; }
    }

    function createWaveSVG(){
        const ns='http://www.w3.org/2000/svg';
        const svg=document.createElementNS(ns,'svg');
        svg.setAttribute('width','24'); 
        svg.setAttribute('height','24'); 
        svg.setAttribute('viewBox','0 0 24 24'); 
        
        const p1=document.createElementNS(ns,'path'); 
        p1.setAttribute('class','wave'); 
        p1.setAttribute('d','M2 12s2-2 4-2 4 2 4 2 2-2 4-2 4 2 4 2'); 
        svg.appendChild(p1);
        
        const p2=document.createElementNS(ns,'path'); 
        p2.setAttribute('class','wave'); 
        p2.setAttribute('d','M2 16s2-2 4-2 4 2 4 2 2-2 4-2 4 2 4 2'); 
        p2.style.animationDelay='-1s'; 
        svg.appendChild(p2);
        
        return svg.outerHTML;
    }

    function createGlowArrow(direction,size='1.1em'){
        const arrow=direction==='up'?'▲':'▼';
        const color=direction==='up'?'#32CD32':'#FF4500';
        // গ্লোয়িং এফেক্টের জন্য টেক্সট শ্যাডো
        const shadow=`0 0 5px ${color},0 0 10px ${color}`; 
        return `<span style="font-size:${size};color:${color};text-shadow:${shadow};margin-left:5px;position:relative;top:${direction==='up'?'-2px':'2px'};">${arrow}</span>`;
    }

    function approxTides(baseTime){
        let base=new Date();
        if(baseTime && baseTime.includes('T')) base=new Date(baseTime);
        else if(baseTime){
            const d=new Date();
            const [h,m]=baseTime.split(':').map(Number);
            base=new Date(d.getFullYear(),d.getMonth(),d.getDate(),h,m,0);
        }
        // জোয়ার থেকে ভাটার সময় প্রায় ৬ ঘণ্টা ১২ মিনিট
        const gap=(6*60+12)*60000; 
        const out=[];
        const types=['উচ্চ জোয়ার','নিম্ন ভাটা','উচ্চ জোয়ার','নিম্ন ভাটা'];
        for(let i=0;i<4;i++){
            let t=new Date(base.getTime()+i*gap);
            out.push({ type:types[i], time:formatToBengali(t,true), level:(i%2===0)?'high':'low', timestamp:t.getTime() });
        }
        // timestamps এর ভিত্তিতে সাজানো হলো
        return out.sort((a,b)=>a.timestamp-b.timestamp);
    }

    // --- সংশোধিত ডাইনামিক লজিক ---
    function getDynamicLevelInfo(tides){
        if(!tides || tides.length < 2) return {level:50,direction:'static',nextEventIndex:-1};
        const now=Date.now();
        
        let nextIndex = -1;
        // বর্তমান সময়ের ঠিক পরের ইভেন্টটি খুঁজে নেওয়া হলো
        nextIndex = tides.findIndex(t => t.timestamp > now);
        
        let past = null;
        let next = null;
        
        if (nextIndex === -1) {
            // যদি দিনের সব ইভেন্ট শেষ হয়ে যায়, তবে শেষ ইভেন্টটি 'past' এবং প্রথম ইভেন্টটি (পরের দিনের) 'next' হবে।
            past = tides[tides.length - 1];
            
            // প্রথম ইভেন্টটিকে পরের দিনে নিয়ে আসা হলো
            const nextDayTime = new Date(tides[0].timestamp);
            nextDayTime.setDate(nextDayTime.getDate() + 1);
            next = { ...tides[0], timestamp: nextDayTime.getTime() };
            
            nextIndex = 0; // হাইলাইট করবে প্রথম ইভেন্টকে
        } else {
            // যদি আসন্ন ইভেন্ট পাওয়া যায়
            next = tides[nextIndex];
            
            // তার ঠিক আগের ইভেন্টটি 'past' হবে
            if (nextIndex > 0) {
                past = tides[nextIndex - 1];
            } else {
                // দিনের প্রথম ইভেন্টটি যদি আসন্ন হয়, তবে তার 'past' হবে আগের দিনের শেষ ইভেন্ট।
                const previousDayTime = new Date(tides[tides.length - 1].timestamp);
                previousDayTime.setDate(previousDayTime.getDate() - 1);
                past = { ...tides[tides.length - 1], timestamp: previousDayTime.getTime() };
            }
        }
        
        // যদি past এবং next ইভেন্ট পাওয়া যায়, তবেই জলস্তরের হিসেব করা হবে
        if (!past || !next || next.timestamp <= past.timestamp) {
             return {level:50, direction:'static', nextEventIndex: nextIndex };
        }

        // 5% (নিম্ন ভাটা) থেকে 95% (উচ্চ জোয়ার) পর্যন্ত জলস্তর নির্দেশক
        const startLevel = past.level === 'high' ? 95 : 5;
        const endLevel = next.level === 'high' ? 95 : 5;

        let level = 50;
        let direction = 'static';

        const totalDuration = next.timestamp - past.timestamp;
        const elapsedDuration = now - past.timestamp;
        
        // Interpolation (রৈখিক অনুমান)
        let ratio = elapsedDuration / totalDuration;
        ratio = Math.max(0, Math.min(1, ratio)); // 0 থেকে 1 এর মধ্যে সীমাবদ্ধ রাখা হলো

        level = startLevel + ((endLevel - startLevel) * ratio);
        direction = endLevel > startLevel ? 'up' : 'down';

        level = Math.round(Math.max(5, Math.min(95, level))); 
        
        // জোয়ার (উচ্চ জোয়ারের দিকে) হলে 'up', ভাটা (নিম্ন ভাটার দিকে) হলে 'down'
        // ইন্ডিকেটরটি আসন্ন ইভেন্ট নির্দেশ করবে, তাই next এর উপর নির্ভর করবে
        
        // যখন 'উচ্চ জোয়ার' এর দিকে যাচ্ছে (স্তর বাড়ছে), তখন direction 'up'
        // যখন 'নিম্ন ভাটা' এর দিকে যাচ্ছে (স্তর কমছে), তখন direction 'down'
        // এটি লজিক থেকে ইতিমধ্যেই নির্ধারিত
        
        return { level:level, direction:direction, nextEventIndex:nextIndex };
    }
    // --- সংশোধিত ডাইনামিক লজিক সমাপ্ত ---

    function loadCoordinates(){
        // ২. GPS/IP থেকে লোকেশন লোড করা হচ্ছে এবং টাইম জোন অনুযায়ী সময় ফিক্স করা হচ্ছে
        return new Promise((resolve, reject) => {
            // GPS চেষ্টা
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    resolve({
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        source: 'GPS',
                        // GPS থেকে সরাসরি শহর পাওয়া যায় না, তাই IP API এর উপর নির্ভর করা হলো বা ডিফল্ট রাখা হলো
                        city: STATE.city // আগের শহরটি ব্যবহার করা হলো, পরে IP API তে আপডেট হবে
                    });
                }, () => {
                    // GPS ব্যর্থ হলে IP API ব্যবহার করা হলো
                    fetch(API_IP).then(r=>r.json()).then(j=>{
                        resolve({
                            lat: j.latitude || DEFAULT.lat,
                            lng: j.longitude || DEFAULT.lng,
                            source: 'IP API',
                            city: j.city || DEFAULT.city
                        });
                    }).catch(()=>resolve(DEFAULT));
                }, {timeout: 5000}); // ৫ সেকেন্ডে টাইমআউট
            } else {
                // যদি ব্রাউজারে GPS সাপোর্ট না করে, IP API ব্যবহার করা হলো
                fetch(API_IP).then(r=>r.json()).then(j=>{
                    resolve({
                        lat: j.latitude || DEFAULT.lat,
                        lng: j.longitude || DEFAULT.lng,
                        source: 'IP API',
                        city: j.city || DEFAULT.city
                    });
                }).catch(()=>resolve(DEFAULT));
            }
        });
    }

    function buildTideList(tides,info){
        let html='';
        tides.forEach((t,i)=>{
            const hi=i===info.nextEventIndex;
            // আসন্ন ইভেন্টে দিকনির্দেশক তীরচিহ্ন
            const ar=hi?createGlowArrow(info.direction,'0.9em'):''; 
            html+=`
            <div class="tide-item-compact ${hi?'highlight':''}">
                <span class="tide-label-group">
                    <div class="tide-icon-svg">${createWaveSVG()}</div>
                    <div class="tide-text-stack">
                        <span class="tide-type-value">${t.type}${ar}</span>
                        <span class="tide-time-value">${t.time}</span>
                    </div>
                </span>
            </div>`;
        });
        return html;
    }

    function updateLiveUI(){
        if(!STATE.tides.length) return;
        
        const currentTime=new Date();
        $('local-time-live').textContent=formatToBengali(currentTime,true,true);
        
        const dynInfo=getDynamicLevelInfo(STATE.tides);
        const {level,direction}=dynInfo;
        
        // জলস্তর আপডেট
        $('water-fill').style.height=level+"%";
        
        // জলস্তর টেক্সট আপডেট
        $('water-level-text').textContent=level+"%";
        $('water-level-text').style.bottom=`calc(${level}% - 8px)`; 

        // জোয়ার-ভাটা তালিকা আপডেট (হাইলাইট ও ইন্ডিকেটর)
        $('tide-events-list').innerHTML=buildTideList(STATE.tides,dynInfo);
        
        // উপরের তীরচিহ্ন আপডেট
        $('panel-arrow-indicator').innerHTML=direction!=='static'?createGlowArrow(direction,'1.4em'):'';
    }

    function buildWidget(data){
        const dyn=getDynamicLevelInfo(data.tides);
        const arrow=dyn.direction!=='static'?createGlowArrow(dyn.direction,'1.4em'):'';
        const currentTime=new Date();
        const currentBengaliTime=formatToBengali(currentTime,true,true);
        const currentDate=formatToBengali(currentTime,false);
        
        return `
        <div class="tide-panel">
            
            <div class="level-indicator-container">
                <div id="water-level-text" class="water-level-text" 
                     style="bottom:calc(${dyn.level}% - 8px);">${dyn.level}%</div>
                <div class="level-indicator-bar">
                    <div id="water-fill" class="water-fill" style="height:${dyn.level}%"></div>
                </div>
            </div>

            <div class="tide-content">
                <div class="tide-header-section">
                    <div class="tide-header-title">জোয়ার-ভাটা</div>
                    <div style="text-align:right;font-size:0.7em;">
                        <span id="panel-arrow-indicator">${arrow}</span><br>বর্তমান জলস্তর
                    </div>
                </div>
                <div class="tide-events-list" id="tide-events-list">${buildTideList(data.tides,dyn)}</div>
                
                <div class="footer-tags-section">
                    <div class="tide-date-footer">আজ: ${currentDate}</div>
                    <div class="location-time-tag">
                        স্থান: <span>${data.city}</span> | স্থানীয় সময়:
                        <span id="local-time-live">${currentBengaliTime}</span>
                    </div>
                </div>
            </div>
        </div>`;
    }

    async function loadAllData(){
        const coords=await loadCoordinates();
        STATE.lat=coords.lat; STATE.lng=coords.lng; STATE.city=coords.city;

        let moon=null;
        try{
            // Open-Meteo API call for moonrise time (tide anchor)
            const r=await fetch(API_OM+`?latitude=${STATE.lat}&longitude=${STATE.lng}&daily=moonrise&timezone=auto`);
            if (!r.ok) throw new Error("API not OK");
            const j=await r.json();
            moon=(j.daily&&j.daily.moonrise&&j.daily.moonrise[0])?j.daily.moonrise[0]:FALLBACK_DATA.tide_anchor_fallback;
        }catch(e){
            console.error("Tide data API error, using fallback time.", e);
            moon=FALLBACK_DATA.tide_anchor_fallback;
        }

        STATE.tides=approxTides(moon);
        
        // শহরের নাম আপডেট করা হলো
        document.querySelector('.location-time-tag span').textContent = STATE.city;

        $('madhabam-tide-widget').innerHTML=buildWidget(STATE);

        if(updateUIInterval) clearInterval(updateUIInterval);
        updateUIInterval=setInterval(updateLiveUI,100); 
        
        if(updateDataInterval) clearInterval(updateDataInterval);
        // প্রতি 30 মিনিটে ডেটা পুনরায় লোড করা হবে
        updateDataInterval=setInterval(loadAllData,1800000); 
    }

    loadAllData();
})();
</script>
